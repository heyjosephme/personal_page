---
import Layout from "@/layouts/Layout.astro";
import { getCollection } from "astro:content";
import { Breadcrumb } from "@/components/Breadcrumb";
import { Badge } from "@/components/ui/badge";
import { Book, Star } from "lucide-react";

const allBooksRaw = await getCollection("books");
// Filter out drafts in production, show all in dev
const allBooks = import.meta.env.DEV
  ? allBooksRaw
  : allBooksRaw.filter((book) => !book.data.draft);

// Group books by status
const currentlyReading = allBooks.filter((book) => book.data.status === "reading");
const completed = allBooks
  .filter((book) => book.data.status === "completed")
  .sort((a, b) => {
    // Sort by dateFinished descending
    const dateA = a.data.dateFinished?.getTime() || 0;
    const dateB = b.data.dateFinished?.getTime() || 0;
    return dateB - dateA;
  });
const wantToRead = allBooks.filter((book) => book.data.status === "want-to-read");

// Helper to render star rating
function renderStars(rating: number | undefined) {
  if (!rating) return null;
  return "★".repeat(rating) + "☆".repeat(5 - rating);
}

// Helper to format date
function formatDate(date: Date | undefined) {
  if (!date) return null;
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
  });
}
---

<Layout
  title="Reading - Joseph"
  description="Books I'm reading, have read, and want to read."
>
  <div class="px-4 py-24 mx-auto max-w-5xl">
    <Breadcrumb items={[{ label: "Reading" }]} className="mb-6" />

    <div class="mb-12">
      <h1 class="text-4xl font-bold mb-4 flex items-center gap-3">
        <Book className="w-8 h-8" />
        Reading List
      </h1>
      <p class="text-muted-foreground text-lg">
        Books that have shaped my thinking about software, life, and everything in between.
      </p>
    </div>

    {/* Currently Reading */}
    {currentlyReading.length > 0 && (
      <section class="mb-16">
        <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">
          <span class="inline-block w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
          Currently Reading
        </h2>
        <div class="grid gap-6 md:grid-cols-2">
          {currentlyReading.map((book) => (
            <a
              href={`/reading/${book.slug}`}
              class="group flex gap-4 p-4 rounded-xl border bg-card hover:shadow-lg transition-all hover:border-primary/50"
            >
              {book.data.coverImage && (
                <img
                  src={book.data.coverImage}
                  alt={book.data.title}
                  class="w-20 h-28 object-cover rounded-md shadow-md group-hover:shadow-lg transition-shadow"
                />
              )}
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-lg group-hover:text-primary transition-colors line-clamp-2">
                  {book.data.title}
                </h3>
                <p class="text-muted-foreground text-sm">{book.data.author}</p>
                {book.data.tags.length > 0 && (
                  <div class="flex flex-wrap gap-1 mt-2">
                    {book.data.tags.slice(0, 3).map((tag) => (
                      <Badge variant="secondary" className="text-xs">
                        {tag}
                      </Badge>
                    ))}
                  </div>
                )}
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    {/* Completed */}
    {completed.length > 0 && (
      <section class="mb-16">
        <h2 class="text-2xl font-semibold mb-6">
          Completed ({completed.length})
        </h2>
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {completed.map((book) => (
            <a
              href={`/reading/${book.slug}`}
              class="group flex flex-col p-4 rounded-xl border bg-card hover:shadow-lg transition-all hover:border-primary/50"
            >
              {book.data.coverImage && (
                <img
                  src={book.data.coverImage}
                  alt={book.data.title}
                  class="w-full h-48 object-cover rounded-md shadow-md group-hover:shadow-lg transition-shadow mb-4"
                />
              )}
              <div class="flex-1">
                <h3 class="font-semibold group-hover:text-primary transition-colors line-clamp-2">
                  {book.data.title}
                </h3>
                <p class="text-muted-foreground text-sm">{book.data.author}</p>
                <div class="flex items-center justify-between mt-2">
                  {book.data.rating && (
                    <span class="text-yellow-500 text-sm">
                      {renderStars(book.data.rating)}
                    </span>
                  )}
                  {book.data.dateFinished && (
                    <span class="text-muted-foreground text-xs">
                      {formatDate(book.data.dateFinished)}
                    </span>
                  )}
                </div>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    {/* Want to Read */}
    {wantToRead.length > 0 && (
      <section class="mb-16">
        <h2 class="text-2xl font-semibold mb-6 text-muted-foreground">
          Want to Read ({wantToRead.length})
        </h2>
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {wantToRead.map((book) => (
            <a
              href={`/reading/${book.slug}`}
              class="group flex gap-3 p-3 rounded-lg border bg-card/50 hover:bg-card hover:shadow-md transition-all"
            >
              {book.data.coverImage && (
                <img
                  src={book.data.coverImage}
                  alt={book.data.title}
                  class="w-12 h-16 object-cover rounded shadow"
                />
              )}
              <div class="flex-1 min-w-0">
                <h3 class="font-medium text-sm group-hover:text-primary transition-colors line-clamp-1">
                  {book.data.title}
                </h3>
                <p class="text-muted-foreground text-xs">{book.data.author}</p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    {/* Empty State */}
    {allBooks.length === 0 && (
      <div class="text-center py-20 text-muted-foreground">
        <Book className="w-16 h-16 mx-auto mb-4 opacity-50" />
        <p>No books yet. Add some to src/content/books/</p>
      </div>
    )}
  </div>
</Layout>
